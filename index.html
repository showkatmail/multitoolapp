<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multi-Tool Web App - Enhanced</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    animation: {
                        'spin-slow': 'spin 3s linear infinite',
                        'pulse-slow': 'pulse 3s infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.3s ease-out',
                        'bounce-in': 'bounceIn 0.6s ease-out'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' }
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' }
                        },
                        bounceIn: {
                            '0%': { transform: 'scale(0.3)', opacity: '0' },
                            '50%': { transform: 'scale(1.05)' },
                            '70%': { transform: 'scale(0.9)' },
                            '100%': { transform: 'scale(1)', opacity: '1' }
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Custom scrollbar styles */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        .dark ::-webkit-scrollbar-track {
            background: #374151;
        }
        ::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        
        /* Transition for theme switching */
        * {
            transition: background-color 0.3s ease, color 0.3s ease, border-color 0.3s ease;
        }
        
        /* Rich text editor styles */
        .editor-content {
            min-height: 300px;
            outline: none;
        }
        .editor-content:focus {
            outline: none;
        }
        .editor-content img {
            max-width: 100%;
            height: auto;
        }
        
        /* Image gallery styles */
        .image-gallery {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }
        
        /* Loading animation */
        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid white;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        /* Tooltip styles */
        .tooltip {
            position: relative;
        }
        .tooltip-text {
            visibility: hidden;
            width: 200px;
            background-color: #333;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px 10px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Keyboard shortcut hint */
        .kbd {
            background-color: #f4f4f4;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2), 0 0 0 2px #fff inset;
            color: #333;
            display: inline-block;
            font-size: .7em;
            line-height: 1;
            padding: 2px 4px;
            white-space: nowrap;
        }
        .dark .kbd {
            background-color: #333;
            border: 1px solid #555;
            color: #f4f4f4;
            box-shadow: 0 1px 0 rgba(0,0,0,0.2), 0 0 0 2px #111 inset;
        }
        
        /* Progress bar */
        .progress-bar {
            height: 4px;
            width: 0%;
            background-color: #4f46e5;
            transition: width 0.3s ease;
        }
        
        /* Image comparison slider */
        .comparison-slider {
            position: relative;
            overflow: hidden;
            cursor: col-resize;
        }
        .comparison-slider .divider {
            position: absolute;
            width: 4px;
            height: 100%;
            background-color: white;
            left: 50%;
            top: 0;
            transform: translateX(-50%);
            z-index: 10;
            cursor: col-resize;
        }
        .comparison-slider .divider::before {
            content: '';
            position: absolute;
            width: 40px;
            height: 40px;
            background: white;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        .comparison-slider .divider::after {
            content: '◀ ▶';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 10px;
            color: #333;
        }
        .comparison-slider .after {
            position: absolute;
            top: 0;
            left: 0;
            width: 50%;
            height: 100%;
            overflow: hidden;
        }
        
        /* Recent files */
        .recent-files {
            max-height: 200px;
            overflow-y: auto;
        }
        
        /* Theme selector */
        .theme-option {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .theme-option:hover {
            transform: scale(1.1);
        }
        .theme-option.active {
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.5);
        }
    </style>
</head>
<body class="h-full bg-gray-50 dark:bg-gray-900 text-gray-900 dark:text-gray-100">
    <!-- Header -->
    <header class="bg-white dark:bg-gray-800 shadow-md">
        <div class="container mx-auto px-4 py-4">
            <div class="flex justify-between items-center">
                <h1 class="text-2xl font-bold text-indigo-600 dark:text-indigo-400 flex items-center">
                    <i class="fas fa-tools mr-2"></i>Multi-Tool Web App
                    <span class="ml-2 text-xs bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200 px-2 py-1 rounded-full">Enhanced</span>
                </h1>
                <div class="flex items-center space-x-4">
                    <button id="help-toggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors tooltip">
                        <i class="fas fa-question-circle"></i>
                        <span class="tooltip-text">Press <kbd>?</kbd> for keyboard shortcuts</span>
                    </button>
                    <button id="theme-toggle" class="p-2 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 transition-colors">
                        <i class="fas fa-moon dark:hidden"></i>
                        <i class="fas fa-sun hidden dark:inline"></i>
                    </button>
                </div>
            </div>
        </div>
        <!-- Progress Bar -->
        <div class="h-1 bg-gray-200 dark:bg-gray-700">
            <div id="progress-bar" class="progress-bar"></div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-4 py-6">
        <!-- Tab Navigation -->
        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md mb-6">
            <div class="flex flex-wrap border-b border-gray-200 dark:border-gray-700">
                <button class="tab-btn px-6 py-3 font-medium text-indigo-600 dark:text-indigo-400 border-b-2 border-indigo-600 dark:border-indigo-400" data-tab="notepad">
                    <i class="fas fa-sticky-note mr-2"></i>Notepad
                </button>
                <button class="tab-btn px-6 py-3 font-medium text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400" data-tab="image-tools">
                    <i class="fas fa-image mr-2"></i>Image Tools
                </button>
                <button class="tab-btn px-6 py-3 font-medium text-gray-600 dark:text-gray-400 hover:text-indigo-600 dark:hover:text-indigo-400" data-tab="settings">
                    <i class="fas fa-cog mr-2"></i>Settings
                </button>
            </div>
        </div>

        <!-- Tab Content -->
        <div class="tab-content">
            <!-- Notepad Tab -->
            <div id="notepad-tab" class="tab-panel">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <div class="mb-4 flex flex-wrap gap-2 border-b border-gray-200 dark:border-gray-700 pb-4">
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="bold" title="Bold">
                            <i class="fas fa-bold"></i>
                            <span class="tooltip-text">Bold <kbd>Ctrl+B</kbd></span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="italic" title="Italic">
                            <i class="fas fa-italic"></i>
                            <span class="tooltip-text">Italic <kbd>Ctrl+I</kbd></span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="underline" title="Underline">
                            <i class="fas fa-underline"></i>
                            <span class="tooltip-text">Underline <kbd>Ctrl+U</kbd></span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="strikeThrough" title="Strikethrough">
                            <i class="fas fa-strikethrough"></i>
                            <span class="tooltip-text">Strikethrough</span>
                        </button>
                        <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="justifyLeft" title="Align Left">
                            <i class="fas fa-align-left"></i>
                            <span class="tooltip-text">Align Left</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="justifyCenter" title="Align Center">
                            <i class="fas fa-align-center"></i>
                            <span class="tooltip-text">Align Center</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="justifyRight" title="Align Right">
                            <i class="fas fa-align-right"></i>
                            <span class="tooltip-text">Align Right</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="justifyFull" title="Justify">
                            <i class="fas fa-align-justify"></i>
                            <span class="tooltip-text">Justify</span>
                        </button>
                        <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="insertUnorderedList" title="Bullet List">
                            <i class="fas fa-list-ul"></i>
                            <span class="tooltip-text">Bullet List</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="insertOrderedList" title="Numbered List">
                            <i class="fas fa-list-ol"></i>
                            <span class="tooltip-text">Numbered List</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="indent" title="Indent">
                            <i class="fas fa-indent"></i>
                            <span class="tooltip-text">Indent</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="outdent" title="Outdent">
                            <i class="fas fa-outdent"></i>
                            <span class="tooltip-text">Outdent</span>
                        </button>
                        <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                        <select class="editor-select px-3 py-1 rounded bg-gray-200 dark:bg-gray-700" id="font-size">
                            <option value="1">Small</option>
                            <option value="3" selected>Normal</option>
                            <option value="5">Large</option>
                            <option value="7">Extra Large</option>
                        </select>
                        <select class="editor-select px-3 py-1 rounded bg-gray-200 dark:bg-gray-700" id="font-family">
                            <option value="Arial">Arial</option>
                            <option value="Times New Roman">Times New Roman</option>
                            <option value="Courier New">Courier New</option>
                            <option value="Georgia">Georgia</option>
                            <option value="Verdana">Verdana</option>
                        </select>
                        <input type="color" class="editor-color w-8 h-8 rounded" id="text-color" value="#000000" title="Text Color">
                        <input type="color" class="editor-color w-8 h-8 rounded" id="bg-color" value="#ffffff" title="Background Color">
                        <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="createLink" title="Insert Link">
                            <i class="fas fa-link"></i>
                            <span class="tooltip-text">Insert Link</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="insertHorizontalRule" title="Horizontal Rule">
                            <i class="fas fa-minus"></i>
                            <span class="tooltip-text">Horizontal Rule</span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="removeFormat" title="Clear Formatting">
                            <i class="fas fa-eraser"></i>
                            <span class="tooltip-text">Clear Formatting</span>
                        </button>
                        <div class="border-l border-gray-300 dark:border-gray-600 mx-2"></div>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="undo" title="Undo">
                            <i class="fas fa-undo"></i>
                            <span class="tooltip-text">Undo <kbd>Ctrl+Z</kbd></span>
                        </button>
                        <button class="editor-btn px-3 py-1 rounded bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 tooltip" data-command="redo" title="Redo">
                            <i class="fas fa-redo"></i>
                            <span class="tooltip-text">Redo <kbd>Ctrl+Y</kbd></span>
                        </button>
                    </div>
                    <div id="editor" class="editor-content p-4 border border-gray-300 dark:border-gray-600 rounded-lg bg-white dark:bg-gray-700" contenteditable="true">
                        Start typing your notes here...
                    </div>
                    <div class="mt-4 flex justify-between">
                        <div class="flex space-x-2">
                            <button id="clear-editor" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-trash mr-2"></i>Clear
                            </button>
                            <button id="word-count" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-calculator mr-2"></i>Word Count
                            </button>
                        </div>
                        <div class="space-x-2">
                            <button id="export-html" class="px-4 py-2 bg-purple-500 hover:bg-purple-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-code mr-2"></i>Export HTML
                            </button>
                            <button id="save-local" class="px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-save mr-2"></i>Save Locally
                            </button>
                            <button id="download-text" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                <i class="fas fa-download mr-2"></i>Download
                            </button>
                        </div>
                    </div>
                    <div id="word-count-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-md w-full mx-4 animate-bounce-in">
                            <h3 class="text-lg font-semibold mb-4">Document Statistics</h3>
                            <div class="space-y-2">
                                <div class="flex justify-between">
                                    <span>Words:</span>
                                    <span id="word-count-value" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Characters:</span>
                                    <span id="char-count-value" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Characters (no spaces):</span>
                                    <span id="char-no-space-count-value" class="font-medium">0</span>
                                </div>
                                <div class="flex justify-between">
                                    <span>Paragraphs:</span>
                                    <span id="paragraph-count-value" class="font-medium">0</span>
                                </div>
                            </div>
                            <div class="mt-4 flex justify-end">
                                <button id="close-word-count" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                    Close
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Image Tools Tab -->
            <div id="image-tools-tab" class="tab-panel hidden">
                <div class="grid grid-cols-1 lg:grid-cols-4 gap-6">
                    <!-- Image Tools Sidebar -->
                    <div class="lg:col-span-1">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <h2 class="text-xl font-semibold mb-4">Image Tools</h2>
                            <div class="space-y-2">
                                <button id="thumbnail-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-compress mr-2"></i>Thumbnail Generator
                                </button>
                                <button id="resize-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-expand-arrows-alt mr-2"></i>Resize
                                </button>
                                <button id="compress-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-file-archive mr-2"></i>Compress
                                </button>
                                <button id="convert-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-exchange-alt mr-2"></i>Convert
                                </button>
                                <button id="watermark-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-tint mr-2"></i>Watermark
                                </button>
                                <button id="merge-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-object-group mr-2"></i>Image Merger
                                </button>
                                <button id="filter-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-magic mr-2"></i>Filters & Effects
                                </button>
                                <button id="metadata-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-info-circle mr-2"></i>Metadata
                                </button>
                                <button id="batch-tool" class="image-tool-btn w-full text-left px-4 py-3 rounded-lg bg-gray-200 dark:bg-gray-700 hover:bg-indigo-100 dark:hover:bg-gray-600 transition-colors">
                                    <i class="fas fa-layer-group mr-2"></i>Batch Process
                                </button>
                            </div>
                            
                            <!-- Image Upload -->
                            <div class="mt-6">
                                <label for="image-upload" class="block w-full cursor-pointer">
                                    <div class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-6 text-center hover:border-indigo-500 dark:hover:border-indigo-400 transition-colors">
                                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                                        <p id="upload-prompt" class="text-sm text-gray-600 dark:text-gray-400">
                                            Select an Image
                                        </p>
                                        <p class="text-xs text-gray-500 dark:text-gray-500 mt-1">or drag and drop</p>
                                    </div>
                                </label>
                                <input type="file" id="image-upload" class="hidden" accept="image/*" multiple>
                            </div>
                            
                            <!-- Recent Files -->
                            <div class="mt-6">
                                <h3 class="text-sm font-medium mb-2">Recent Files</h3>
                                <div id="recent-files" class="recent-files space-y-2">
                                    <!-- Recent files will be added here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Preview and Controls -->
                    <div class="lg:col-span-3">
                        <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                            <div class="flex justify-between items-center mb-4">
                                <h2 class="text-xl font-semibold">Preview</h2>
                                <div class="flex space-x-2">
                                    <button id="compare-toggle" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors hidden">
                                        <i class="fas fa-columns mr-1"></i>Compare
                                    </button>
                                    <button id="reset-image" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors hidden">
                                        <i class="fas fa-undo mr-1"></i>Reset
                                    </button>
                                    <button id="zoom-in" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-search-plus"></i>
                                    </button>
                                    <button id="zoom-out" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-search-minus"></i>
                                    </button>
                                    <button id="zoom-fit" class="px-3 py-1 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors">
                                        <i class="fas fa-expand"></i>
                                    </button>
                                </div>
                            </div>
                            <div id="image-preview-container" class="min-h-[300px] flex items-center justify-center border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg overflow-hidden relative">
                                <div class="text-center text-gray-500 dark:text-gray-400">
                                    <i class="fas fa-image text-4xl mb-2"></i>
                                    <p>No image selected</p>
                                </div>
                            </div>
                            
                            <!-- Tool Controls -->
                            <div id="tool-controls" class="mt-6 space-y-4">
                                <!-- Thumbnail Controls -->
                                <div id="thumbnail-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Thumbnail Settings</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Width (px)</label>
                                            <input type="number" id="thumb-width" value="150" min="50" max="500" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Height (px)</label>
                                            <input type="number" id="thumb-height" value="150" min="50" max="500" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="thumb-crop" checked class="mr-2">
                                            <span class="text-sm">Crop to fit (recommended)</span>
                                        </label>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button id="generate-thumbnail" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                            Generate Thumbnail
                                        </button>
                                    </div>
                                </div>

                                <!-- Resize Controls -->
                                <div id="resize-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Resize Settings</h3>
                                    <div class="grid grid-cols-2 gap-4">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Width (px)</label>
                                            <input type="number" id="resize-width" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                        </div>
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Height (px)</label>
                                            <input type="number" id="resize-height" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <label class="flex items-center">
                                            <input type="checkbox" id="maintain-aspect" checked class="mr-2">
                                            <span class="text-sm">Maintain aspect ratio</span>
                                        </label>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button id="apply-resize" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                            Apply Resize
                                        </button>
                                    </div>
                                </div>

                                <!-- Compress Controls -->
                                <div id="compress-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Compression Settings</h3>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Quality (1-100)</label>
                                        <input type="range" id="compress-quality" min="1" max="100" value="80" class="w-full">
                                        <div class="flex justify-between text-xs text-gray-500 dark:text-gray-400">
                                            <span>Low</span>
                                            <span id="quality-value">80</span>
                                            <span>High</span>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button id="apply-compress" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                            Apply Compression
                                        </button>
                                    </div>
                                </div>

                                <!-- Convert Controls -->
                                <div id="convert-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Convert Format</h3>
                                    <div>
                                        <label class="block text-sm font-medium mb-1">Output Format</label>
                                        <select id="output-format" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                            <option value="jpeg">JPEG</option>
                                            <option value="png">PNG</option>
                                            <option value="webp">WebP</option>
                                            <option value="bmp">BMP</option>
                                            <option value="tiff">TIFF</option>
                                            <option value="gif">GIF</option>
                                        </select>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button id="apply-convert" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                            Convert Image
                                        </button>
                                    </div>
                                </div>

                                <!-- Watermark Controls -->
                                <div id="watermark-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Watermark Settings</h3>
                                    <div class="space-y-3">
                                        <div>
                                            <label class="block text-sm font-medium mb-1">Text</label>
                                            <input type="text" id="watermark-text" placeholder="Enter watermark text" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Position</label>
                                                <select id="watermark-position" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                                    <option value="top-left">Top Left</option>
                                                    <option value="top-right">Top Right</option>
                                                    <option value="bottom-left">Bottom Left</option>
                                                    <option value="bottom-right">Bottom Right</option>
                                                    <option value="center">Center</option>
                                                </select>
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Opacity</label>
                                                <input type="range" id="watermark-opacity" min="0" max="100" value="50" class="w-full">
                                            </div>
                                        </div>
                                        <div class="grid grid-cols-2 gap-3">
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Font Size</label>
                                                <input type="number" id="watermark-size" value="20" min="10" max="100" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-medium mb-1">Color</label>
                                                <input type="color" id="watermark-color" value="#ffffff" class="w-full h-10 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button id="apply-watermark" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                            Apply Watermark
                                        </button>
                                    </div>
                                </div>

                                <!-- Merge Controls -->
                                <div id="merge-controls" class="image-tool-panel hidden">
                                    <!-- This will be populated by showMergeControls() function -->
                                </div>

                                <!-- Filter Controls -->
                                <div id="filter-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Filters & Effects</h3>
                                    <div class="grid grid-cols-2 gap-3">
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="grayscale">
                                            <i class="fas fa-adjust mr-1"></i>Grayscale
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="sepia">
                                            <i class="fas fa-coffee mr-1"></i>Sepia
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="invert">
                                            <i class="fas fa-exchange-alt mr-1"></i>Invert
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="blur">
                                            <i class="fas fa-water mr-1"></i>Blur
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="sharpen">
                                            <i class="fas fa-mountain mr-1"></i>Sharpen
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="brightness">
                                            <i class="fas fa-lightbulb mr-1"></i>Brightness
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="contrast">
                                            <i class="fas fa-circle-half-stroke mr-1"></i>Contrast
                                        </button>
                                        <button class="filter-btn px-3 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg text-sm transition-colors" data-filter="vintage">
                                            <i class="fas fa-camera-retro mr-1"></i>Vintage
                                        </button>
                                    </div>
                                    <div class="mt-4 flex justify-between">
                                        <button id="reset-filters" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                            Reset All
                                        </button>
                                        <button id="apply-filters" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors">
                                            Apply Filters
                                        </button>
                                    </div>
                                </div>

                                <!-- Metadata Controls -->
                                <div id="metadata-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Image Metadata</h3>
                                    <div id="metadata-content" class="bg-gray-100 dark:bg-gray-700 rounded-lg p-4 max-h-96 overflow-y-auto">
                                        <p class="text-center text-gray-500 dark:text-gray-400">No image selected</p>
                                    </div>
                                    <div class="mt-4 flex justify-end">
                                        <button id="export-metadata" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors disabled:opacity-50" disabled>
                                            Export Metadata
                                        </button>
                                    </div>
                                </div>

                                <!-- Batch Process Controls -->
                                <div id="batch-controls" class="image-tool-panel hidden">
                                    <h3 class="text-lg font-medium mb-3">Batch Processing</h3>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-1">Select Operation</label>
                                        <select id="batch-operation" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                                            <option value="resize">Resize</option>
                                            <option value="compress">Compress</option>
                                            <option value="convert">Convert Format</option>
                                            <option value="watermark">Add Watermark</option>
                                        </select>
                                    </div>
                                    <div class="mb-4">
                                        <label class="block text-sm font-medium mb-1">Select Images</label>
                                        <div id="batch-images" class="border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg p-4 text-center">
                                            <p class="text-gray-500 dark:text-gray-400">Drop images here or click to select</p>
                                            <input type="file" id="batch-upload" class="hidden" accept="image/*" multiple>
                                        </div>
                                    </div>
                                    <div class="mt-4 flex justify-between">
                                        <button id="clear-batch" class="px-4 py-2 bg-gray-500 hover:bg-gray-600 text-white rounded-lg transition-colors">
                                            Clear All
                                        </button>
                                        <button id="process-batch" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg transition-colors disabled:opacity-50" disabled>
                                            Process Batch
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="settings-tab" class="tab-panel hidden">
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-md p-6">
                    <h2 class="text-xl font-semibold mb-6">Settings</h2>
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-medium mb-3">Appearance</h3>
                            <div class="space-y-3">
                                <label class="flex items-center justify-between">
                                    <span>Dark Mode</span>
                                    <div class="relative">
                                        <input type="checkbox" id="dark-mode-toggle" class="sr-only">
                                        <div class="w-10 h-6 bg-gray-300 dark:bg-indigo-600 rounded-full shadow-inner"></div>
                                        <div class="dot absolute w-4 h-4 bg-white rounded-full shadow left-1 top-1 transition"></div>
                                    </div>
                                </label>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-medium mb-3">Storage</h3>
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <span>Storage Used</span>
                                    <span id="storage-used" class="text-sm">0 KB</span>
                                </div>
                                <div class="w-full bg-gray-200 dark:bg-gray-700 rounded-full h-2">
                                    <div id="storage-bar" class="bg-indigo-600 h-2 rounded-full" style="width: 0%"></div>
                                </div>
                                <button id="clear-storage" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition-colors">
                                    <i class="fas fa-trash mr-2"></i>Clear All Local Data
                                </button>
                            </div>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-medium mb-3">About</h3>
                            <div class="text-sm text-gray-600 dark:text-gray-400">
                                <p>Multi-Tool Web App v2.0 Enhanced</p>
                                <p>A comprehensive tool for text editing and image manipulation</p>
                                <p class="mt-2">© 2023 Multi-Tool Web App. All rights reserved.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Help Modal -->
    <div id="help-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white dark:bg-gray-800 rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto animate-bounce-in">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-semibold">Keyboard Shortcuts</h3>
                <button id="close-help" class="text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <h4 class="font-medium mb-2">General</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span>Show Help</span>
                            <kbd>?</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Toggle Dark Mode</span>
                            <kbd>Ctrl+D</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Save Current Work</span>
                            <kbd>Ctrl+S</kbd>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium mb-2">Notepad</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span>Bold</span>
                            <kbd>Ctrl+B</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Italic</span>
                            <kbd>Ctrl+I</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Underline</span>
                            <kbd>Ctrl+U</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Undo</span>
                            <kbd>Ctrl+Z</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Redo</span>
                            <kbd>Ctrl+Y</kbd>
                        </div>
                    </div>
                </div>
                <div>
                    <h4 class="font-medium mb-2">Image Tools</h4>
                    <div class="space-y-1 text-sm">
                        <div class="flex justify-between">
                            <span>Zoom In</span>
                            <kbd>Ctrl+</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Zoom Out</span>
                            <kbd>Ctrl-</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Reset Zoom</span>
                            <kbd>Ctrl+0</kbd>
                        </div>
                        <div class="flex justify-between">
                            <span>Reset Image</span>
                            <kbd>Ctrl+R</kbd>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container" class="fixed bottom-4 right-4 z-50"></div>

    <script>
        // Global variables
        let currentImageData = null;
        let originalImageData = null;
        let selectedMergeImages = [];
        let mergedImageData = null;
        let currentTool = null;
        let imageHistory = [];
        let historyIndex = -1;
        let zoomLevel = 1;
        let recentFiles = [];
        let batchImages = [];
        let activeFilters = [];
        let currentTheme = 'light';

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            initializeTabs();
            initializeEditor();
            initializeImageTools();
            initializeSettings();
            loadSavedContent();
            loadRecentFiles();
            initializeKeyboardShortcuts();
            updateStorageInfo();
        });

        // Theme Management
        function initializeTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            
            // Check for saved theme preference
            const savedTheme = localStorage.getItem('theme') || 'light';
            setTheme(savedTheme);
            
            themeToggle.addEventListener('click', toggleTheme);
            darkModeToggle.addEventListener('change', toggleTheme);
        }

        function setTheme(theme) {
            currentTheme = theme;
            localStorage.setItem('theme', theme);
            
            const html = document.documentElement;
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            
            if (theme === 'dark') {
                html.classList.add('dark');
                darkModeToggle.checked = true;
            } else {
                html.classList.remove('dark');
                darkModeToggle.checked = false;
            }
        }

        function toggleTheme() {
            const html = document.documentElement;
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            
            if (html.classList.contains('dark')) {
                setTheme('light');
            } else {
                setTheme('dark');
            }
        }

        // Keyboard Shortcuts
        function initializeKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Help modal
                if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                    toggleHelpModal();
                    return;
                }
                
                // Ctrl/Cmd combinations
                if (e.ctrlKey || e.metaKey) {
                    switch(e.key) {
                        case 'd':
                            e.preventDefault();
                            toggleTheme();
                            break;
                        case 's':
                            e.preventDefault();
                            saveCurrentWork();
                            break;
                        case '+':
                        case '=':
                            e.preventDefault();
                            if (currentImageData) zoomImage(1.2);
                            break;
                        case '-':
                            e.preventDefault();
                            if (currentImageData) zoomImage(0.8);
                            break;
                        case '0':
                            e.preventDefault();
                            if (currentImageData) resetZoom();
                            break;
                        case 'r':
                            e.preventDefault();
                            if (currentImageData) resetImage();
                            break;
                    }
                }
            });
        }

        function toggleHelpModal() {
            const helpModal = document.getElementById('help-modal');
            helpModal.classList.toggle('hidden');
        }

        function saveCurrentWork() {
            const activeTab = document.querySelector('.tab-btn.text-indigo-600');
            if (!activeTab) {
                // Try alternative selector for dark mode
                const darkModeTab = document.querySelector('.tab-btn.dark\\:text-indigo-400');
                if (!darkModeTab) return;
                
                const tabName = darkModeTab.getAttribute('data-tab');
                
                if (tabName === 'notepad') {
                    document.getElementById('save-local').click();
                } else if (tabName === 'image-tools' && currentImageData) {
                    // Save current image to recent files
                    addToRecentFiles(currentImageData);
                    showNotification('Image saved to recent files', 'success');
                }
                return;
            }
            
            const tabName = activeTab.getAttribute('data-tab');
            
            if (tabName === 'notepad') {
                document.getElementById('save-local').click();
            } else if (tabName === 'image-tools' && currentImageData) {
                // Save current image to recent files
                addToRecentFiles(currentImageData);
                showNotification('Image saved to recent files', 'success');
            }
        }

        // Tab Management - FIXED VERSION
        function initializeTabs() {
            const tabButtons = document.querySelectorAll('.tab-btn');
            const tabPanels = document.querySelectorAll('.tab-panel');
            
            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const targetTab = button.getAttribute('data-tab');
                    
                    // Update button states
                    tabButtons.forEach(btn => {
                        btn.classList.remove('text-indigo-600', 'dark:text-indigo-400', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
                        btn.classList.add('text-gray-600', 'dark:text-gray-400');
                    });
                    
                    button.classList.remove('text-gray-600', 'dark:text-gray-400');
                    button.classList.add('text-indigo-600', 'dark:text-indigo-400', 'border-b-2', 'border-indigo-600', 'dark:border-indigo-400');
                    
                    // Update panel visibility
                    tabPanels.forEach(panel => {
                        panel.classList.add('hidden');
                    });
                    
                    const targetPanel = document.getElementById(`${targetTab}-tab`);
                    if (targetPanel) {
                        targetPanel.classList.remove('hidden');
                    }
                });
            });
        }

        // Rich Text Editor
        function initializeEditor() {
            const editor = document.getElementById('editor');
            const editorButtons = document.querySelectorAll('.editor-btn');
            const fontSizeSelect = document.getElementById('font-size');
            const fontFamilySelect = document.getElementById('font-family');
            const textColorInput = document.getElementById('text-color');
            const bgColorInput = document.getElementById('bg-color');
            
            // Add event listeners to editor buttons
            editorButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const command = button.getAttribute('data-command');
                    
                    if (command === 'createLink') {
                        const url = prompt('Enter URL:');
                        if (url) document.execCommand(command, false, url);
                    } else {
                        document.execCommand(command, false, null);
                    }
                    
                    editor.focus();
                });
            });
            
            // Font size change
            fontSizeSelect.addEventListener('change', () => {
                document.execCommand('fontSize', false, fontSizeSelect.value);
                editor.focus();
            });
            
            // Font family change
            fontFamilySelect.addEventListener('change', () => {
                document.execCommand('fontName', false, fontFamilySelect.value);
                editor.focus();
            });
            
            // Text color change
            textColorInput.addEventListener('change', () => {
                document.execCommand('foreColor', false, textColorInput.value);
                editor.focus();
            });
            
            // Background color change
            bgColorInput.addEventListener('change', () => {
                document.execCommand('hiliteColor', false, bgColorInput.value);
                editor.focus();
            });
            
            // Clear editor
            document.getElementById('clear-editor').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all content?')) {
                    editor.innerHTML = '';
                    showNotification('Editor cleared', 'info');
                }
            });
            
            // Word count
            document.getElementById('word-count').addEventListener('click', () => {
                updateWordCount();
                document.getElementById('word-count-modal').classList.remove('hidden');
            });
            
            document.getElementById('close-word-count').addEventListener('click', () => {
                document.getElementById('word-count-modal').classList.add('hidden');
            });
            
            // Export HTML
            document.getElementById('export-html').addEventListener('click', () => {
                const htmlContent = editor.innerHTML;
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notepad-${new Date().toISOString().slice(0, 10)}.html`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('HTML exported successfully', 'success');
            });
            
            // Save locally
            document.getElementById('save-local').addEventListener('click', () => {
                const content = editor.innerHTML;
                localStorage.setItem('notepad-content', content);
                showNotification('Content saved locally', 'success');
            });
            
            // Download as text file
            document.getElementById('download-text').addEventListener('click', () => {
                const content = editor.innerText;
                const blob = new Blob([content], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `notepad-${new Date().toISOString().slice(0, 10)}.txt`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showNotification('File downloaded successfully', 'success');
            });
            
            // Auto-save
            editor.addEventListener('input', () => {
                localStorage.setItem('notepad-content', editor.innerHTML);
            });
        }

        function updateWordCount() {
            const editor = document.getElementById('editor');
            const text = editor.innerText;
            
            const words = text.trim().split(/\s+/).filter(word => word.length > 0);
            const characters = text.length;
            const charactersNoSpace = text.replace(/\s/g, '').length;
            const paragraphs = text.trim().split(/\n\n+/).filter(p => p.length > 0);
            
            document.getElementById('word-count-value').textContent = words.length;
            document.getElementById('char-count-value').textContent = characters;
            document.getElementById('char-no-space-count-value').textContent = charactersNoSpace;
            document.getElementById('paragraph-count-value').textContent = paragraphs.length;
        }

        // Image Tools
        function initializeImageTools() {
            const imageToolButtons = document.querySelectorAll('.image-tool-btn');
            const imageUpload = document.getElementById('image-upload');
            
            // Tool selection
            imageToolButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tool = button.id.replace('-tool', '');
                    selectImageTool(tool);
                });
            });
            
            // Image upload
            imageUpload.addEventListener('change', handleImageUpload);
            
            // Drag and drop
            const uploadLabel = imageUpload.previousElementSibling;
            uploadLabel.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadLabel.classList.add('border-indigo-500', 'dark:border-indigo-400');
            });
            
            uploadLabel.addEventListener('dragleave', () => {
                uploadLabel.classList.remove('border-indigo-500', 'dark:border-indigo-400');
            });
            
            uploadLabel.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadLabel.classList.remove('border-indigo-500', 'dark:border-indigo-400');
                
                const files = Array.from(e.dataTransfer.files);
                
                if (files.length > 0) {
                    processImageFiles(files);
                }
            });
            
            // Zoom controls
            document.getElementById('zoom-in').addEventListener('click', () => {
                if (currentImageData) zoomImage(1.2);
            });
            
            document.getElementById('zoom-out').addEventListener('click', () => {
                if (currentImageData) zoomImage(0.8);
            });
            
            document.getElementById('zoom-fit').addEventListener('click', () => {
                if (currentImageData) resetZoom();
            });
            
            // Reset image
            document.getElementById('reset-image').addEventListener('click', resetImage);
            
            // Compare toggle
            document.getElementById('compare-toggle').addEventListener('click', toggleComparison);
            
            // Initialize tool-specific event listeners
            initializeThumbnailTool();
            initializeResizeTool();
            initializeCompressTool();
            initializeConvertTool();
            initializeWatermarkTool();
            initializeFilterTool();
            initializeMetadataTool();
            initializeBatchTool();
        }

        function selectImageTool(tool) {
            // Store current tool
            currentTool = tool;
            
            // Hide all tool panels
            document.querySelectorAll('.image-tool-panel').forEach(panel => {
                panel.classList.add('hidden');
            });
            
            // Reset merge images when switching away from merge tool
            if (tool !== 'merge' && selectedMergeImages) {
                selectedMergeImages = [];
                mergedImageData = null;
            }
            
            // Update active state in toolbar
            document.querySelectorAll('.image-tool-btn').forEach(btn => {
                btn.classList.remove('bg-indigo-600', 'text-white');
                btn.classList.add('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
            });
            
            const activeButton = document.getElementById(`${tool}-tool`);
            if (activeButton) {
                activeButton.classList.remove('bg-gray-200', 'dark:bg-gray-700', 'text-gray-700', 'dark:text-gray-300');
                activeButton.classList.add('bg-indigo-600', 'text-white');
            }
            
            // Clear preview container when switching tools
            document.getElementById('image-preview-container').innerHTML = '';
            
            // Show the appropriate control panel for the selected tool
            const controlPanel = document.getElementById(`${tool}-controls`);
            if (controlPanel) {
                controlPanel.classList.remove('hidden');
            }
            
            // Special handling for merge tool
            if (tool === 'merge') {
                // Initialize merge mode
                selectedMergeImages = [];
                mergedImageData = null;
                
                // Update upload prompt
                document.getElementById('upload-prompt').innerHTML = `
                    <p class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Select Multiple Images to Merge</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Choose 2 or more images to combine into one</p>
                `;
                
                // Show merge controls panel immediately
                showMergeControls();
            } else {
                // Reset upload prompt for other tools
                document.getElementById('upload-prompt').innerHTML = `
                    <p class="text-lg font-medium text-gray-700 dark:text-gray-300 mb-2">Select an Image</p>
                    <p class="text-sm text-gray-500 dark:text-gray-400">Choose an image to ${tool}</p>
                `;
            }
            
            // Show/hide relevant buttons
            if (currentImageData) {
                document.getElementById('reset-image').classList.remove('hidden');
                document.getElementById('compare-toggle').classList.remove('hidden');
            }
        }

        function handleImageUpload(e) {
            const files = Array.from(e.target.files);
            
            if (files.length > 0) {
                processImageFiles(files);
            }
            
            // Reset the input value
            e.target.value = '';
        }

        function processImageFiles(files) {
            // For merge tool, handle multiple files
            if (currentTool === 'merge') {
                // Process each file
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            const imageData = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                dataURL: event.target.result,
                                timestamp: Date.now()
                            };
                            
                            showImagePreview(imageData);
                        };
                        
                        reader.readAsDataURL(file);
                    } else {
                        showNotification(`${file.name} is not a valid image file`, 'error');
                    }
                });
            } else {
                // For other tools, only handle the first file
                const file = files[0];
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    
                    reader.onload = function(event) {
                        const imageData = {
                            name: file.name,
                            size: file.size,
                            type: file.type,
                            dataURL: event.target.result,
                            timestamp: Date.now()
                        };
                        
                        // Reset history
                        imageHistory = [];
                        historyIndex = -1;
                        
                        // Set current and original image data
                        currentImageData = imageData;
                        originalImageData = JSON.parse(JSON.stringify(imageData));
                        
                        // Add to history
                        addToHistory(imageData);
                        
                        // Add to recent files
                        addToRecentFiles(imageData);
                        
                        showImagePreview(imageData);
                        
                        // Update resize tool with image dimensions
                        if (currentTool === 'resize') {
                            updateResizeDimensions(imageData);
                        }
                        
                        // Show metadata if metadata tool is active
                        if (currentTool === 'metadata') {
                            updateMetadata(imageData);
                        }
                    };
                    
                    reader.readAsDataURL(file);
                } else {
                    showNotification(`${file.name} is not a valid image file`, 'error');
                }
            }
        }

        // Enhanced showImagePreview function to handle multiple images
        function showImagePreview(imageData) {
            const previewContainer = document.getElementById('image-preview-container');
            
            // Check if we're in merge mode
            if (currentTool === 'merge') {
                // For merge mode, we need to handle multiple images
                if (!selectedMergeImages) {
                    selectedMergeImages = [];
                }
                
                // Add the new image to our array
                selectedMergeImages.push(imageData);
                
                // Clear the container and rebuild with all selected images
                previewContainer.innerHTML = '';
                
                // Create a grid container for selected images
                const selectedImagesGrid = document.createElement('div');
                selectedImagesGrid.id = 'selected-images-grid';
                selectedImagesGrid.className = 'grid grid-cols-2 gap-2 mb-4';
                
                // Add each selected image to the grid
                selectedMergeImages.forEach((img, index) => {
                    const imageWrapper = document.createElement('div');
                    imageWrapper.className = 'relative group';
                    
                    const imgElement = document.createElement('img');
                    imgElement.src = img.dataURL;
                    imgElement.className = 'w-full h-32 object-cover rounded border-2 border-indigo-500';
                    
                    // Add remove button
                    const removeBtn = document.createElement('button');
                    removeBtn.className = 'absolute top-1 right-1 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity';
                    removeBtn.innerHTML = '&times;';
                    removeBtn.onclick = () => removeMergeImage(index);
                    
                    imageWrapper.appendChild(imgElement);
                    imageWrapper.appendChild(removeBtn);
                    selectedImagesGrid.appendChild(imageWrapper);
                });
                
                previewContainer.appendChild(selectedImagesGrid);
                
                // Add merge result preview container (initially hidden)
                let mergeResultPreview = document.getElementById('merge-result-preview');
                if (!mergeResultPreview) {
                    mergeResultPreview = document.createElement('div');
                    mergeResultPreview.id = 'merge-result-preview';
                    mergeResultPreview.className = 'hidden mt-4';
                    previewContainer.appendChild(mergeResultPreview);
                }
                
                // Update merge controls state
                updateMergeControlsState();
            } else {
                // For non-merge modes, show single image with zoom controls
                previewContainer.innerHTML = '';
                
                const imageContainer = document.createElement('div');
                imageContainer.className = 'relative w-full h-full flex items-center justify-center';
                imageContainer.id = 'image-container';
                
                const imgElement = document.createElement('img');
                imgElement.src = imageData.dataURL;
                imgElement.alt = 'Preview';
                imgElement.className = 'max-w-full max-h-96 mx-auto rounded-lg shadow-lg transition-transform duration-200';
                imgElement.id = 'preview-image';
                imgElement.style.transform = `scale(${zoomLevel})`;
                
                imageContainer.appendChild(imgElement);
                previewContainer.appendChild(imageContainer);
                
                // Add image info
                const infoDiv = document.createElement('div');
                infoDiv.className = 'mt-2 text-sm text-gray-600 dark:text-gray-400 text-center';
                infoDiv.innerHTML = `
                    ${imageData.name} (${formatFileSize(imageData.size)})
                    <span class="ml-2 text-xs">Zoom: ${Math.round(zoomLevel * 100)}%</span>
                `;
                previewContainer.appendChild(infoDiv);
                
                // Show/hide relevant buttons
                document.getElementById('reset-image').classList.remove('hidden');
                document.getElementById('compare-toggle').classList.remove('hidden');
            }
        }

        // Zoom functionality
        function zoomImage(factor) {
            zoomLevel = Math.max(0.1, Math.min(5, zoomLevel * factor));
            const imgElement = document.getElementById('preview-image');
            if (imgElement) {
                imgElement.style.transform = `scale(${zoomLevel})`;
                
                // Update zoom info
                const infoDiv = document.querySelector('#image-preview-container .text-center');
                if (infoDiv) {
                    infoDiv.innerHTML = infoDiv.innerHTML.replace(/Zoom: \d+%/, `Zoom: ${Math.round(zoomLevel * 100)}%`);
                }
            }
        }

        function resetZoom() {
            zoomLevel = 1;
            const imgElement = document.getElementById('preview-image');
            if (imgElement) {
                imgElement.style.transform = `scale(${zoomLevel})`;
                
                // Update zoom info
                const infoDiv = document.querySelector('#image-preview-container .text-center');
                if (infoDiv) {
                    infoDiv.innerHTML = infoDiv.innerHTML.replace(/Zoom: \d+%/, `Zoom: ${Math.round(zoomLevel * 100)}%`);
                }
            }
        }

        // Image history management
        function addToHistory(imageData) {
            // Remove any states after current index
            imageHistory = imageHistory.slice(0, historyIndex + 1);
            
            // Add new state
            imageHistory.push(JSON.parse(JSON.stringify(imageData)));
            historyIndex++;
            
            // Limit history to 20 states
            if (imageHistory.length > 20) {
                imageHistory.shift();
                historyIndex--;
            }
        }

        function resetImage() {
            if (originalImageData) {
                currentImageData = JSON.parse(JSON.stringify(originalImageData));
                showImagePreview(currentImageData);
                addToHistory(currentImageData);
                showNotification('Image reset to original', 'info');
            }
        }

        // Comparison functionality
        function toggleComparison() {
            const previewContainer = document.getElementById('image-preview-container');
            const imgElement = document.getElementById('preview-image');
            
            if (!imgElement || !originalImageData) return;
            
            // Check if comparison view already exists
            if (document.getElementById('comparison-container')) {
                // Remove comparison view
                showImagePreview(currentImageData);
                return;
            }
            
            // Create comparison container
            const comparisonContainer = document.createElement('div');
            comparisonContainer.id = 'comparison-container';
            comparisonContainer.className = 'comparison-slider w-full h-full relative';
            
            // Create before image (original)
            const beforeImg = document.createElement('img');
            beforeImg.src = originalImageData.dataURL;
            beforeImg.className = 'w-full h-full object-contain';
            
            // Create after image (current)
            const afterContainer = document.createElement('div');
            afterContainer.className = 'after';
            afterContainer.style.width = '50%';
            
            const afterImg = document.createElement('img');
            afterImg.src = currentImageData.dataURL;
            afterImg.className = 'w-full h-full object-contain';
            
            // Create divider
            const divider = document.createElement('div');
            divider.className = 'divider';
            
            // Assemble comparison
            afterContainer.appendChild(afterImg);
            comparisonContainer.appendChild(beforeImg);
            comparisonContainer.appendChild(afterContainer);
            comparisonContainer.appendChild(divider);
            
            // Clear preview and add comparison
            previewContainer.innerHTML = '';
            previewContainer.appendChild(comparisonContainer);
            
            // Add slider functionality
            let isDragging = false;
            
            const updateSliderPosition = (x) => {
                const rect = comparisonContainer.getBoundingClientRect();
                const position = Math.max(0, Math.min(1, (x - rect.left) / rect.width));
                afterContainer.style.width = `${position * 100}%`;
            };
            
            divider.addEventListener('mousedown', () => {
                isDragging = true;
            });
            
            document.addEventListener('mousemove', (e) => {
                if (isDragging) {
                    updateSliderPosition(e.clientX);
                }
            });
            
            document.addEventListener('mouseup', () => {
                isDragging = false;
            });
        }

        // Recent files management
        function addToRecentFiles(imageData) {
            // Check if file already exists in recent files
            const existingIndex = recentFiles.findIndex(file => file.name === imageData.name);
            
            if (existingIndex !== -1) {
                // Update existing file
                recentFiles[existingIndex] = imageData;
            } else {
                // Add new file
                recentFiles.unshift(imageData);
            }
            
            // Limit to 10 recent files
            recentFiles = recentFiles.slice(0, 10);
            
            // Save to localStorage
            localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
            
            // Update UI
            updateRecentFilesUI();
        }

        function loadRecentFiles() {
            const saved = localStorage.getItem('recentFiles');
            if (saved) {
                try {
                    recentFiles = JSON.parse(saved);
                    updateRecentFilesUI();
                } catch (e) {
                    console.error('Error loading recent files:', e);
                    recentFiles = [];
                }
            }
        }

        function updateRecentFilesUI() {
            const container = document.getElementById('recent-files');
            container.innerHTML = '';
            
            if (recentFiles.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 dark:text-gray-400">No recent files</p>';
                return;
            }
            
            recentFiles.forEach((file, index) => {
                const fileItem = document.createElement('div');
                fileItem.className = 'flex items-center space-x-2 p-2 rounded hover:bg-gray-100 dark:hover:bg-gray-700 cursor-pointer transition-colors';
                
                const thumbnail = document.createElement('img');
                thumbnail.src = file.dataURL;
                thumbnail.className = 'w-10 h-10 object-cover rounded';
                
                const fileInfo = document.createElement('div');
                fileInfo.className = 'flex-1 min-w-0';
                
                const fileName = document.createElement('p');
                fileName.className = 'text-sm font-medium truncate';
                fileName.textContent = file.name;
                
                const fileSize = document.createElement('p');
                fileSize.className = 'text-xs text-gray-500 dark:text-gray-400';
                fileSize.textContent = formatFileSize(file.size);
                
                fileInfo.appendChild(fileName);
                fileInfo.appendChild(fileSize);
                
                const removeBtn = document.createElement('button');
                removeBtn.className = 'text-red-500 hover:text-red-700 dark:text-red-400 dark:hover:text-red-300';
                removeBtn.innerHTML = '<i class="fas fa-times"></i>';
                removeBtn.onclick = (e) => {
                    e.stopPropagation();
                    recentFiles.splice(index, 1);
                    localStorage.setItem('recentFiles', JSON.stringify(recentFiles));
                    updateRecentFilesUI();
                };
                
                fileItem.appendChild(thumbnail);
                fileItem.appendChild(fileInfo);
                fileItem.appendChild(removeBtn);
                
                fileItem.onclick = () => {
                    currentImageData = file;
                    originalImageData = JSON.parse(JSON.stringify(file));
                    imageHistory = [];
                    historyIndex = -1;
                    addToHistory(file);
                    showImagePreview(file);
                    
                    // Update resize tool with image dimensions
                    if (currentTool === 'resize') {
                        updateResizeDimensions(file);
                    }
                    
                    // Show metadata if metadata tool is active
                    if (currentTool === 'metadata') {
                        updateMetadata(file);
                    }
                };
                
                container.appendChild(fileItem);
            });
        }

        // Helper function to remove an image from the merge selection
        function removeMergeImage(index) {
            selectedMergeImages.splice(index, 1);
            
            // Re-render the preview
            if (selectedMergeImages.length > 0) {
                // Temporarily store the images and clear the array
                const tempImages = [...selectedMergeImages];
                selectedMergeImages = [];
                
                // Re-add each image to trigger the preview update
                tempImages.forEach(img => showImagePreview(img));
            } else {
                // No images left, clear the preview
                document.getElementById('image-preview-container').innerHTML = '';
                updateMergeControlsState();
            }
        }

        // Updated showMergeControls() function
        function showMergeControls() {
            const mergeControls = document.getElementById('merge-controls');
            mergeControls.classList.remove('hidden');
            
            // Update the controls HTML with separate Apply and Download buttons
            mergeControls.innerHTML = `
                <div class="bg-white dark:bg-gray-800 rounded-lg shadow-lg p-4">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800 dark:text-white">Merge Settings</h3>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Direction</label>
                        <select id="merge-direction" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
                            <option value="horizontal">Horizontal</option>
                            <option value="vertical">Vertical</option>
                        </select>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Spacing (px)</label>
                        <input type="number" id="merge-spacing" min="0" max="50" value="0" class="w-full px-3 py-2 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700 dark:text-white">
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">Background Color</label>
                        <input type="color" id="merge-bg-color" value="#ffffff" class="w-full h-10 border border-gray-300 dark:border-gray-600 rounded-md focus:outline-none focus:ring-2 focus:ring-indigo-500 dark:bg-gray-700">
                    </div>
                    
                    <div class="flex justify-end space-x-2">
                        <button id="apply-merge" class="px-4 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded transition-colors disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                            Apply Merge
                        </button>
                        <button id="download-merge" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded transition-colors hidden">
                            Download
                        </button>
                    </div>
                    
                    <div id="merge-loading" class="hidden mt-4 flex items-center justify-center">
                        <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-indigo-500"></div>
                        <span class="ml-2 text-gray-600 dark:text-gray-400">Processing images...</span>
                    </div>
                    
                    <div id="merge-result-info" class="hidden mt-4 p-2 bg-gray-100 dark:bg-gray-700 rounded text-sm text-gray-600 dark:text-gray-400">
                        <!-- Result info will be displayed here -->
                    </div>
                </div>
            `;
            
            // Add event listeners
            document.getElementById('apply-merge').addEventListener('click', applyMerge);
            document.getElementById('download-merge').addEventListener('click', downloadMergedImage);
        }

        function updateMergeControlsState() {
            const applyButton = document.getElementById('apply-merge');
            if (applyButton) {
                if (selectedMergeImages.length >= 2) {
                    applyButton.disabled = false;
                } else {
                    applyButton.disabled = true;
                }
            }
        }

        // Apply merge function - creates the merged image and shows preview
        function applyMerge() {
            if (!selectedMergeImages || selectedMergeImages.length < 2) {
                showNotification('Please select at least 2 images to merge', 'error');
                return;
            }
            
            // Show loading state
            document.getElementById('merge-loading').classList.remove('hidden');
            document.getElementById('apply-merge').disabled = true;
            updateProgressBar(30);
            
            // Get merge settings
            const direction = document.getElementById('merge-direction').value;
            const spacing = parseInt(document.getElementById('merge-spacing').value) || 0;
            const bgColor = document.getElementById('merge-bg-color').value;
            
            // Process images with a slight delay to show loading state
            setTimeout(() => {
                try {
                    updateProgressBar(60);
                    
                    // Create a canvas for the merged image
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    // Calculate dimensions based on direction
                    let totalWidth = 0;
                    let totalHeight = 0;
                    let maxWidth = 0;
                    let maxHeight = 0;
                    
                    // Load all images
                    const loadedImages = [];
                    const promises = selectedMergeImages.map(imgData => {
                        return new Promise((resolve) => {
                            const img = new Image();
                            img.onload = () => {
                                loadedImages.push(img);
                                
                                if (direction === 'horizontal') {
                                    totalWidth += img.width;
                                    maxHeight = Math.max(maxHeight, img.height);
                                } else {
                                    totalHeight += img.height;
                                    maxWidth = Math.max(maxWidth, img.width);
                                }
                                
                                resolve();
                            };
                            img.src = imgData.dataURL;
                        });
                    });
                    
                    Promise.all(promises).then(() => {
                        updateProgressBar(80);
                        
                        // Set canvas dimensions
                        if (direction === 'horizontal') {
                            canvas.width = totalWidth + (spacing * (loadedImages.length - 1));
                            canvas.height = maxHeight;
                        } else {
                            canvas.width = maxWidth;
                            canvas.height = totalHeight + (spacing * (loadedImages.length - 1));
                        }
                        
                        // Fill background
                        ctx.fillStyle = bgColor;
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        
                        // Draw images
                        let currentX = 0;
                        let currentY = 0;
                        
                        loadedImages.forEach(img => {
                            if (direction === 'horizontal') {
                                // Center vertically
                                const y = (canvas.height - img.height) / 2;
                                ctx.drawImage(img, currentX, y);
                                currentX += img.width + spacing;
                            } else {
                                // Center horizontally
                                const x = (canvas.width - img.width) / 2;
                                ctx.drawImage(img, x, currentY);
                                currentY += img.height + spacing;
                            }
                        });
                        
                        updateProgressBar(90);
                        
                        // Store the merged image data
                        mergedImageData = canvas.toDataURL('image/png');
                        
                        // Show the preview
                        const previewContainer = document.getElementById('merge-result-preview');
                        previewContainer.innerHTML = `
                            <h4 class="text-md font-semibold mb-2 text-gray-800 dark:text-white">Merged Image Preview</h4>
                            <img src="${mergedImageData}" alt="Merged Image" class="max-w-full max-h-64 mx-auto rounded-lg shadow-lg">
                        `;
                        previewContainer.classList.remove('hidden');
                        
                        // Show result info
                        const fileSize = Math.round(mergedImageData.length * 0.75 / 1024); // Approximate size in KB
                        document.getElementById('merge-result-info').innerHTML = `
                            <p>Dimensions: ${canvas.width} x ${canvas.height}px</p>
                            <p>File Size: ~${fileSize} KB</p>
                        `;
                        document.getElementById('merge-result-info').classList.remove('hidden');
                        
                        // Show download button
                        document.getElementById('download-merge').classList.remove('hidden');
                        
                        // Hide loading state
                        document.getElementById('merge-loading').classList.add('hidden');
                        document.getElementById('apply-merge').disabled = false;
                        
                        updateProgressBar(100);
                        setTimeout(() => updateProgressBar(0), 500);
                        
                        showNotification('Images merged successfully! You can now download the result.', 'success');
                    });
                } catch (error) {
                    console.error('Error merging images:', error);
                    showNotification('Failed to merge images. Please try again.', 'error');
                    
                    // Hide loading state
                    document.getElementById('merge-loading').classList.add('hidden');
                    document.getElementById('apply-merge').disabled = false;
                    updateProgressBar(0);
                }
            }, 500); // Small delay to show loading state
        }

        // Download merged image function
        function downloadMergedImage() {
            if (!mergedImageData) {
                showNotification('No merged image to download. Please apply merge first.', 'error');
                return;
            }
            
            // Create a temporary link element
            const link = document.createElement('a');
            link.href = mergedImageData;
            link.download = `merged-image-${Date.now()}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('Image downloaded successfully!', 'success');
        }

        // Update resize dimensions when image is loaded
        function updateResizeDimensions(imageData) {
            const img = new Image();
            img.onload = function() {
                document.getElementById('resize-width').value = img.width;
                document.getElementById('resize-height').value = img.height;
            };
            img.src = imageData.dataURL;
        }

        // Thumbnail Tool
        function initializeThumbnailTool() {
            document.getElementById('generate-thumbnail').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('Please select an image first', 'error');
                    return;
                }
                
                const width = parseInt(document.getElementById('thumb-width').value);
                const height = parseInt(document.getElementById('thumb-height').value);
                const crop = document.getElementById('thumb-crop').checked;
                
                updateProgressBar(30);
                
                const img = new Image();
                img.onload = function() {
                    updateProgressBar(60);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    if (crop) {
                        // Calculate scaling and positioning to cover the entire canvas
                        const scale = Math.max(width / img.width, height / img.height);
                        const x = (width / 2) - (img.width / 2) * scale;
                        const y = (height / 2) - (img.height / 2) * scale;
                        
                        ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                    } else {
                        // Fit image within canvas
                        const scale = Math.min(width / img.width, height / img.height);
                        const scaledWidth = img.width * scale;
                        const scaledHeight = img.height * scale;
                        const x = (width - scaledWidth) / 2;
                        const y = (height - scaledHeight) / 2;
                        
                        ctx.drawImage(img, x, y, scaledWidth, scaledHeight);
                    }
                    
                    updateProgressBar(90);
                    
                    const thumbnailDataURL = canvas.toDataURL();
                    
                    // Update preview
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = `
                        <img src="${thumbnailDataURL}" alt="Thumbnail" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                        <div class="mt-4 flex justify-center">
                            <button id="download-thumbnail" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Download Thumbnail
                            </button>
                        </div>
                    `;
                    
                    // Add download functionality
                    document.getElementById('download-thumbnail').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = thumbnailDataURL;
                        link.download = `thumbnail-${Date.now()}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification('Thumbnail downloaded successfully', 'success');
                    });
                    
                    updateProgressBar(100);
                    setTimeout(() => updateProgressBar(0), 500);
                };
                img.src = currentImageData.dataURL;
            });
        }

        // Resize Tool
        function initializeResizeTool() {
            const widthInput = document.getElementById('resize-width');
            const heightInput = document.getElementById('resize-height');
            const maintainAspectCheckbox = document.getElementById('maintain-aspect');
            
            // Maintain aspect ratio
            widthInput.addEventListener('input', () => {
                if (maintainAspectCheckbox.checked && currentImageData) {
                    const img = new Image();
                    img.onload = function() {
                        const ratio = img.height / img.width;
                        heightInput.value = Math.round(widthInput.value * ratio);
                    };
                    img.src = currentImageData.dataURL;
                }
            });
            
            heightInput.addEventListener('input', () => {
                if (maintainAspectCheckbox.checked && currentImageData) {
                    const img = new Image();
                    img.onload = function() {
                        const ratio = img.width / img.height;
                        widthInput.value = Math.round(heightInput.value * ratio);
                    };
                    img.src = currentImageData.dataURL;
                }
            });
            
            document.getElementById('apply-resize').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('Please select an image first', 'error');
                    return;
                }
                
                const width = parseInt(widthInput.value);
                const height = parseInt(heightInput.value);
                
                updateProgressBar(30);
                
                const img = new Image();
                img.onload = function() {
                    updateProgressBar(60);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    updateProgressBar(90);
                    
                    const resizedDataURL = canvas.toDataURL();
                    
                    // Update current image data
                    currentImageData.dataURL = resizedDataURL;
                    
                    // Add to history
                    addToHistory(currentImageData);
                    
                    // Update preview
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = `
                        <img src="${resizedDataURL}" alt="Resized" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400 text-center">
                            ${currentImageData.name} (${formatFileSize(currentImageData.size)}) - Resized to ${width}x${height}
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button id="download-resized" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Download Resized Image
                            </button>
                        </div>
                    `;
                    
                    // Add download functionality
                    document.getElementById('download-resized').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = resizedDataURL;
                        link.download = `resized-${Date.now()}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification('Resized image downloaded successfully', 'success');
                    });
                    
                    updateProgressBar(100);
                    setTimeout(() => updateProgressBar(0), 500);
                };
                img.src = currentImageData.dataURL;
            });
        }

        // Compress Tool
        function initializeCompressTool() {
            const qualitySlider = document.getElementById('compress-quality');
            const qualityValue = document.getElementById('quality-value');
            
            qualitySlider.addEventListener('input', () => {
                qualityValue.textContent = qualitySlider.value;
            });
            
            document.getElementById('apply-compress').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('Please select an image first', 'error');
                    return;
                }
                
                const quality = parseInt(qualitySlider.value) / 100;
                
                updateProgressBar(30);
                
                const img = new Image();
                img.onload = function() {
                    updateProgressBar(60);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    ctx.drawImage(img, 0, 0);
                    
                    const compressedDataURL = canvas.toDataURL('image/jpeg', quality);
                    
                    updateProgressBar(90);
                    
                    // Calculate size reduction
                    const originalSize = currentImageData.dataURL.length * 0.75;
                    const compressedSize = compressedDataURL.length * 0.75;
                    const reduction = ((originalSize - compressedSize) / originalSize * 100).toFixed(1);
                    
                    // Update preview
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = `
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <h4 class="text-sm font-medium mb-2">Original</h4>
                                <img src="${currentImageData.dataURL}" alt="Original" class="w-full h-48 object-cover rounded-lg">
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${formatFileSize(originalSize)}</p>
                            </div>
                            <div>
                                <h4 class="text-sm font-medium mb-2">Compressed (${qualitySlider.value}%)</h4>
                                <img src="${compressedDataURL}" alt="Compressed" class="w-full h-48 object-cover rounded-lg">
                                <p class="text-xs text-gray-600 dark:text-gray-400 mt-1">${formatFileSize(compressedSize)} (${reduction}% smaller)</p>
                            </div>
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button id="download-compressed" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Download Compressed Image
                            </button>
                        </div>
                    `;
                    
                    // Add download functionality
                    document.getElementById('download-compressed').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = compressedDataURL;
                        link.download = `compressed-${Date.now()}.jpg`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification('Compressed image downloaded successfully', 'success');
                    });
                    
                    updateProgressBar(100);
                    setTimeout(() => updateProgressBar(0), 500);
                };
                img.src = currentImageData.dataURL;
            });
        }

        // Convert Tool
        function initializeConvertTool() {
            document.getElementById('apply-convert').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('Please select an image first', 'error');
                    return;
                }
                
                const format = document.getElementById('output-format').value;
                const mimeType = format === 'jpeg' ? 'image/jpeg' : `image/${format}`;
                
                updateProgressBar(30);
                
                const img = new Image();
                img.onload = function() {
                    updateProgressBar(60);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // For PNG/WebP, preserve transparency
                    if (format !== 'jpeg') {
                        ctx.drawImage(img, 0, 0);
                    } else {
                        // For JPEG, add white background
                        ctx.fillStyle = '#FFFFFF';
                        ctx.fillRect(0, 0, canvas.width, canvas.height);
                        ctx.drawImage(img, 0, 0);
                    }
                    
                    updateProgressBar(90);
                    
                    const convertedDataURL = canvas.toDataURL(mimeType);
                    
                    // Update preview
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = `
                        <img src="${convertedDataURL}" alt="Converted" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400 text-center">
                            Converted to ${format.toUpperCase()}
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button id="download-converted" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Download as ${format.toUpperCase()}
                            </button>
                        </div>
                    `;
                    
                    // Add download functionality
                    document.getElementById('download-converted').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = convertedDataURL;
                        link.download = `converted-${Date.now()}.${format}`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification(`Image converted to ${format.toUpperCase()} successfully`, 'success');
                    });
                    
                    updateProgressBar(100);
                    setTimeout(() => updateProgressBar(0), 500);
                };
                img.src = currentImageData.dataURL;
            });
        }

        // Watermark Tool
        function initializeWatermarkTool() {
            document.getElementById('apply-watermark').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('Please select an image first', 'error');
                    return;
                }
                
                const text = document.getElementById('watermark-text').value;
                if (!text) {
                    showNotification('Please enter watermark text', 'error');
                    return;
                }
                
                const position = document.getElementById('watermark-position').value;
                const opacity = parseInt(document.getElementById('watermark-opacity').value) / 100;
                const fontSize = parseInt(document.getElementById('watermark-size').value);
                const color = document.getElementById('watermark-color').value;
                
                updateProgressBar(30);
                
                const img = new Image();
                img.onload = function() {
                    updateProgressBar(60);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw the original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Configure watermark text
                    ctx.font = `${fontSize}px Arial`;
                    ctx.fillStyle = color;
                    ctx.globalAlpha = opacity;
                    
                    // Calculate text position
                    const textMetrics = ctx.measureText(text);
                    const textWidth = textMetrics.width;
                    const textHeight = fontSize;
                    const padding = 20;
                    
                    let x, y;
                    switch(position) {
                        case 'top-left':
                            x = padding;
                            y = padding + textHeight;
                            break;
                        case 'top-right':
                            x = canvas.width - textWidth - padding;
                            y = padding + textHeight;
                            break;
                        case 'bottom-left':
                            x = padding;
                            y = canvas.height - padding;
                            break;
                        case 'bottom-right':
                            x = canvas.width - textWidth - padding;
                            y = canvas.height - padding;
                            break;
                        case 'center':
                            x = (canvas.width - textWidth) / 2;
                            y = (canvas.height + textHeight) / 2;
                            break;
                    }
                    
                    // Draw watermark
                    ctx.fillText(text, x, y);
                    
                    updateProgressBar(90);
                    
                    // Update preview
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = `
                        <img src="${canvas.toDataURL()}" alt="Watermarked" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400 text-center">
                            Watermark applied
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button id="download-watermarked" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Download Watermarked Image
                            </button>
                        </div>
                    `;
                    
                    // Add download functionality
                    document.getElementById('download-watermarked').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL();
                        link.download = `watermarked-${Date.now()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification('Watermarked image downloaded successfully', 'success');
                    });
                    
                    updateProgressBar(100);
                    setTimeout(() => updateProgressBar(0), 500);
                };
                img.src = currentImageData.dataURL;
            });
        }

        // Filter Tool
        function initializeFilterTool() {
            const filterButtons = document.querySelectorAll('.filter-btn');
            
            filterButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const filter = button.getAttribute('data-filter');
                    
                    // Toggle active state
                    if (activeFilters.includes(filter)) {
                        activeFilters = activeFilters.filter(f => f !== filter);
                        button.classList.remove('bg-indigo-200', 'dark:bg-indigo-800');
                    } else {
                        activeFilters.push(filter);
                        button.classList.add('bg-indigo-200', 'dark:bg-indigo-800');
                    }
                });
            });
            
            document.getElementById('reset-filters').addEventListener('click', () => {
                activeFilters = [];
                filterButtons.forEach(button => {
                    button.classList.remove('bg-indigo-200', 'dark:bg-indigo-800');
                });
            });
            
            document.getElementById('apply-filters').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('Please select an image first', 'error');
                    return;
                }
                
                if (activeFilters.length === 0) {
                    showNotification('Please select at least one filter', 'error');
                    return;
                }
                
                updateProgressBar(30);
                
                const img = new Image();
                img.onload = function() {
                    updateProgressBar(60);
                    
                    const canvas = document.createElement('canvas');
                    const ctx = canvas.getContext('2d');
                    
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw original image
                    ctx.drawImage(img, 0, 0);
                    
                    // Get image data
                    const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                    const data = imageData.data;
                    
                    // Apply each filter
                    activeFilters.forEach(filter => {
                        applyFilter(data, filter, canvas.width, canvas.height);
                    });
                    
                    // Put the modified image data back
                    ctx.putImageData(imageData, 0, 0);
                    
                    updateProgressBar(90);
                    
                    // Update preview
                    const previewContainer = document.getElementById('image-preview-container');
                    previewContainer.innerHTML = `
                        <img src="${canvas.toDataURL()}" alt="Filtered" class="max-w-full max-h-96 mx-auto rounded-lg shadow-lg">
                        <div class="mt-2 text-sm text-gray-600 dark:text-gray-400 text-center">
                            Filters applied: ${activeFilters.join(', ')}
                        </div>
                        <div class="mt-4 flex justify-center">
                            <button id="download-filtered" class="px-4 py-2 bg-green-500 hover:bg-green-600 text-white rounded-lg transition-colors">
                                Download Filtered Image
                            </button>
                        </div>
                    `;
                    
                    // Add download functionality
                    document.getElementById('download-filtered').addEventListener('click', () => {
                        const link = document.createElement('a');
                        link.href = canvas.toDataURL();
                        link.download = `filtered-${Date.now()}.png`;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                        showNotification('Filtered image downloaded successfully', 'success');
                    });
                    
                    updateProgressBar(100);
                    setTimeout(() => updateProgressBar(0), 500);
                };
                img.src = currentImageData.dataURL;
            });
        }

        function applyFilter(data, filter, width, height) {
            switch(filter) {
                case 'grayscale':
                    for (let i = 0; i < data.length; i += 4) {
                        const gray = data[i] * 0.299 + data[i + 1] * 0.587 + data[i + 2] * 0.114;
                        data[i] = gray;
                        data[i + 1] = gray;
                        data[i + 2] = gray;
                    }
                    break;
                case 'sepia':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        data[i] = Math.min(255, (r * 0.393) + (g * 0.769) + (b * 0.189));
                        data[i + 1] = Math.min(255, (r * 0.349) + (g * 0.686) + (b * 0.168));
                        data[i + 2] = Math.min(255, (r * 0.272) + (g * 0.534) + (b * 0.131));
                    }
                    break;
                case 'invert':
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = 255 - data[i];
                        data[i + 1] = 255 - data[i + 1];
                        data[i + 2] = 255 - data[i + 2];
                    }
                    break;
                case 'brightness':
                    const brightnessFactor = 1.2;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, data[i] * brightnessFactor);
                        data[i + 1] = Math.min(255, data[i + 1] * brightnessFactor);
                        data[i + 2] = Math.min(255, data[i + 2] * brightnessFactor);
                    }
                    break;
                case 'contrast':
                    const contrastFactor = 1.5;
                    for (let i = 0; i < data.length; i += 4) {
                        data[i] = Math.min(255, Math.max(0, (data[i] - 128) * contrastFactor + 128));
                        data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * contrastFactor + 128));
                        data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * contrastFactor + 128));
                    }
                    break;
                case 'vintage':
                    for (let i = 0; i < data.length; i += 4) {
                        const r = data[i];
                        const g = data[i + 1];
                        const b = data[i + 2];
                        data[i] = Math.min(255, (r * 0.5) + 50);
                        data[i + 1] = Math.min(255, (g * 0.4) + 30);
                        data[i + 2] = Math.min(255, (b * 0.2) + 10);
                    }
                    break;
                // Add more filters as needed
            }
        }

        // Metadata Tool
        function initializeMetadataTool() {
            document.getElementById('export-metadata').addEventListener('click', () => {
                if (!currentImageData) {
                    showNotification('No image to export metadata for', 'error');
                    return;
                }
                
                // Create a simple metadata object
                const metadata = {
                    name: currentImageData.name,
                    size: currentImageData.size,
                    type: currentImageData.type,
                    timestamp: currentImageData.timestamp || new Date().toISOString()
                };
                
                // Convert to JSON and download
                const dataStr = JSON.stringify(metadata, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const link = document.createElement('a');
                link.setAttribute('href', dataUri);
                link.setAttribute('download', `${currentImageData.name.split('.')[0]}_metadata.json`);
                link.click();
                
                showNotification('Metadata exported successfully', 'success');
            });
        }

        function updateMetadata(imageData) {
            const metadataContent = document.getElementById('metadata-content');
            
            // Create a simple metadata display
            const metadata = {
                'File Name': imageData.name,
                'File Size': formatFileSize(imageData.size),
                'File Type': imageData.type,
                'Timestamp': new Date(imageData.timestamp || Date.now()).toLocaleString()
            };
            
            let metadataHTML = '<div class="space-y-2">';
            for (const [key, value] of Object.entries(metadata)) {
                metadataHTML += `
                    <div class="flex justify-between">
                        <span class="font-medium">${key}:</span>
                        <span>${value}</span>
                    </div>
                `;
            }
            metadataHTML += '</div>';
            
            metadataContent.innerHTML = metadataHTML;
            document.getElementById('export-metadata').disabled = false;
        }

        // Batch Tool
        function initializeBatchTool() {
            const batchImagesContainer = document.getElementById('batch-images');
            const batchUpload = document.getElementById('batch-upload');
            
            // Make the container clickable
            batchImagesContainer.addEventListener('click', () => {
                batchUpload.click();
            });
            
            batchUpload.addEventListener('change', (e) => {
                const files = Array.from(e.target.files);
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            const imageData = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                dataURL: event.target.result
                            };
                            
                            batchImages.push(imageData);
                            updateBatchImagesUI();
                        };
                        
                        reader.readAsDataURL(file);
                    }
                });
                
                // Reset the input value
                e.target.value = '';
            });
            
            // Drag and drop for batch images
            batchImagesContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                batchImagesContainer.classList.add('border-indigo-500', 'dark:border-indigo-400');
            });
            
            batchImagesContainer.addEventListener('dragleave', () => {
                batchImagesContainer.classList.remove('border-indigo-500', 'dark:border-indigo-400');
            });
            
            batchImagesContainer.addEventListener('drop', (e) => {
                e.preventDefault();
                batchImagesContainer.classList.remove('border-indigo-500', 'dark:border-indigo-400');
                
                const files = Array.from(e.dataTransfer.files);
                
                files.forEach(file => {
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        
                        reader.onload = function(event) {
                            const imageData = {
                                name: file.name,
                                size: file.size,
                                type: file.type,
                                dataURL: event.target.result
                            };
                            
                            batchImages.push(imageData);
                            updateBatchImagesUI();
                        };
                        
                        reader.readAsDataURL(file);
                    }
                });
            });
            
            document.getElementById('clear-batch').addEventListener('click', () => {
                batchImages = [];
                updateBatchImagesUI();
            });
            
            document.getElementById('process-batch').addEventListener('click', () => {
                if (batchImages.length === 0) {
                    showNotification('Please select images for batch processing', 'error');
                    return;
                }
                
                const operation = document.getElementById('batch-operation').value;
                
                // Show progress
                document.getElementById('batch-progress').classList.remove('hidden');
                
                // Process each image
                let processedCount = 0;
                
                batchImages.forEach((imageData, index) => {
                    setTimeout(() => {
                        // In a real implementation, you would apply the selected operation
                        // For this demo, we'll just simulate processing
                        processedCount++;
                        
                        // Update progress
                        const progress = Math.round((processedCount / batchImages.length) * 100);
                        document.getElementById('batch-progress-bar').style.width = `${progress}%`;
                        document.getElementById('batch-progress-text').textContent = `${progress}%`;
                        
                        if (processedCount === batchImages.length) {
                            setTimeout(() => {
                                document.getElementById('batch-progress').classList.add('hidden');
                                showNotification(`Batch ${operation} completed for ${batchImages.length} images`, 'success');
                            }, 500);
                        }
                    }, index * 500); // Process each image with a delay
                });
            });
        }

        function updateBatchImagesUI() {
            const batchImagesContainer = document.getElementById('batch-images');
            const processButton = document.getElementById('process-batch');
            
            if (batchImages.length === 0) {
                batchImagesContainer.innerHTML = '<p class="text-gray-500 dark:text-gray-400">Drop images here or click to select</p>';
                processButton.disabled = true;
            } else {
                batchImagesContainer.innerHTML = `
                    <div class="grid grid-cols-3 gap-2">
                        ${batchImages.map((img, index) => `
                            <div class="relative group">
                                <img src="${img.dataURL}" alt="${img.name}" class="w-full h-20 object-cover rounded">
                                <button class="absolute top-1 right-1 bg-red-500 text-white rounded-full w-5 h-5 flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity text-xs" onclick="removeBatchImage(${index})">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        `).join('')}
                    </div>
                    <p class="mt-2 text-sm text-gray-600 dark:text-gray-400">${batchImages.length} image(s) selected</p>
                `;
                processButton.disabled = false;
            }
        }

        function removeBatchImage(index) {
            batchImages.splice(index, 1);
            updateBatchImagesUI();
        }

        // Settings
        function initializeSettings() {
            // Dark mode toggle in settings
            const darkModeToggle = document.getElementById('dark-mode-toggle');
            darkModeToggle.addEventListener('change', toggleTheme);
            
            // Clear storage
            document.getElementById('clear-storage').addEventListener('click', () => {
                if (confirm('Are you sure you want to clear all local data? This action cannot be undone.')) {
                    localStorage.clear();
                    showNotification('All local data cleared', 'info');
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            });
        }

        // Utility Functions
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function updateProgressBar(percentage) {
            const progressBar = document.getElementById('progress-bar');
            progressBar.style.width = `${percentage}%`;
        }

        function updateStorageInfo() {
            // Calculate storage usage
            let totalSize = 0;
            
            // Check localStorage
            for (let key in localStorage) {
                if (localStorage.hasOwnProperty(key)) {
                    totalSize += localStorage[key].length;
                }
            }
            
            // Update UI
            const storageUsed = document.getElementById('storage-used');
            const storageBar = document.getElementById('storage-bar');
            
            storageUsed.textContent = formatFileSize(totalSize);
            
            // Assuming 5MB max storage
            const maxStorage = 5 * 1024 * 1024;
            const percentage = Math.min(100, (totalSize / maxStorage) * 100);
            storageBar.style.width = `${percentage}%`;
        }

        function showNotification(message, type = 'info') {
            const container = document.getElementById('notification-container');
            
            // Create notification element
            const notification = document.createElement('div');
            notification.className = `mb-2 px-4 py-3 rounded-lg shadow-lg flex items-center space-x-2 transform transition-all duration-300 translate-x-full`;
            
            // Set color based on type
            if (type === 'success') {
                notification.classList.add('bg-green-500', 'text-white');
            } else if (type === 'error') {
                notification.classList.add('bg-red-500', 'text-white');
            } else {
                notification.classList.add('bg-blue-500', 'text-white');
            }
            
            // Add icon based on type
            let icon = '';
            if (type === 'success') {
                icon = '<i class="fas fa-check-circle"></i>';
            } else if (type === 'error') {
                icon = '<i class="fas fa-exclamation-circle"></i>';
            } else {
                icon = '<i class="fas fa-info-circle"></i>';
            }
            
            notification.innerHTML = `
                ${icon}
                <span>${message}</span>
            `;
            
            // Add to container
            container.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.classList.remove('translate-x-full');
                notification.classList.add('translate-x-0');
            }, 10);
            
            // Remove after 3 seconds
            setTimeout(() => {
                notification.classList.add('translate-x-full');
                setTimeout(() => {
                    container.removeChild(notification);
                }, 300);
            }, 3000);
        }

        function loadSavedContent() {
            // Load saved notepad content
            const savedContent = localStorage.getItem('notepad-content');
            if (savedContent) {
                document.getElementById('editor').innerHTML = savedContent;
            }
        }

        // Help modal
        document.getElementById('help-toggle').addEventListener('click', toggleHelpModal);
        document.getElementById('close-help').addEventListener('click', toggleHelpModal);
    </script>
</body>
</html>
